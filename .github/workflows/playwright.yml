name: Playwright CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  tests:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js & Cache
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸŒ Install Playwright
        run: npx playwright install --with-deps

      - name: â–¶ï¸ Execute tests
        run: npm t

      - name: ğŸ“ Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: allure-results
          retention-days: 20

            - name: ğŸ—ƒï¸ Fetch previous history
        uses: actions/checkout@v4
        if: always()
        with:
          ref: gh-pages
          path: ./history
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_history: ./history
          allure_report: ./report
          keep_reports: 20

      - name: ğŸŒ Deploy Allure Report
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./history


      - name: ğŸ“¦ Setup allurectl
        if: always()
        run: |
          # ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ allurectl
          if [ ! -f "/usr/local/bin/allurectl" ]; then
            echo "Installing allurectl..."
            curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
            chmod +x allurectl
            sudo mv allurectl /usr/local/bin/
          fi

      - name: â˜ï¸ Upload to Allure TestOps
        if: always()
        run: |
          allurectl upload allure-results \
            --endpoint https://allure.autotests.cloud \
            --project-id 5000 \
            --token ${{ secrets.ALLURE_TOKEN }} \
            --launch-name "CI Run #${{ github.run_number }}"

      - name: ğŸ“‹ Parse test summary
        id: parse_summary
        if: always()
        run: |
          file="allure-report/widgets/summary.json"
          if [ -f "$file" ]; then
            echo "PASSED=$(jq -r '.statistic.passed' $file)" >> $GITHUB_ENV
            echo "FAILED=$(jq -r '.statistic.failed' $file)" >> $GITHUB_ENV
            echo "SKIPPED=$(jq -r '.statistic.skipped' $file)" >> $GITHUB_ENV
            echo "TOTAL=$(jq -r '.statistic.total' $file)" >> $GITHUB_ENV
          fi

      - name: ğŸ“¢ Notify in Telegram
        if: always()
        run: |
          status=${{ job.status }}
          if [ "$status" = "success" ]; then
            emoji="âœ…"
            text="Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹"
          else
            emoji="âŒ"
            text="Ğ¢ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸"
          fi

          msg="$emoji *$text* $emoji%0A"
          msg+="%0AğŸ“Š *Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹*:%0A"

          msg+="ğŸ“‹ Ğ’ÑĞµĞ³Ğ¾: *$TOTAL*%0A"
          msg+="âœ… ĞŸÑ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: *$PASSED*%0A"
          msg+="âŒ Ğ£Ğ¿Ğ°Ğ»Ğ¸: *$FAILED*%0A"
          msg+="â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: *$SKIPPED*%0A"
          msg+="%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A"
          msg+="ğŸ”— [ĞÑ‚Ñ‡Ñ‘Ñ‚ Allure]()%0A"
          msg+="ğŸ§ª [TestOps](https://allure.autotests.cloud/project/5000)%0A"
          msg+="ğŸ“¦ [ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)%0A"
          msg+="%0AğŸ·ï¸ *Ğ—Ğ°Ğ¿ÑƒÑĞº #${{ github.run_number }}*"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="$msg"